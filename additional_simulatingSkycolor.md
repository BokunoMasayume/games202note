# [模拟天空的颜色](https://www.scratchapixel.com/lessons/procedural-generation-virtual-worlds/simulating-sky/simulating-colors-of-the-sky)

## 介绍

几个世纪以来, 天空对于致力于尽量精确的描述天空颜色的艺术家非常有魅力. 19世纪前的物理和数学家很想弄清楚是什么导致了天空在日落时时橙色, 白天却是蓝色的. 在历史上, 认为雷利(Rayleigh)发现了大气散射. 大气散射在物体的表现上同样有影响. 这个效果被称作空气透视(aerial perspective). 随着物体和观察者间的距离增加, 物体的颜色被替换为大气的颜色. 这是一个重要的线索, 我们用来评估一个在天际线的物体的距离, 通过比较他们之间的蓝色的深浅. 在图像绘制时, 空气透视可以极大的增加图像的深度. 

更近的历史时计算机图形学的历史, Nishita 在1993年写了一篇开创性的文章“display of the earth taking into account atmospheric scattering”, 在文章中, 他描述了一个模拟天空颜色的算法. 有趣的是, 他的这篇文章和在1996年写的下一篇并不完全关于大气模拟, 而是更注重地球在外太空看到的真实感渲染(包括海水表面, 云和大陆的渲染).

这提醒我们，近年来，计算机图形技术的发展是由制造业驱动的，以精确模拟其产品或提供三维虚拟训练环境, 而不是由娱乐工业驱动?. Nishita 提出的这个技术在他的时代没什么水花. 这一领域的大部分研究都集中在在GPU上实现他的算法, 而没有明显的仿真质量的改善. 另一个天空模型由Preetham & al. 在 siggraph 1999 的文章“A Practical Analytic Model for Daylight”提出. 正如其标题暗示的, 这是一个能提供正确天空颜色模拟的分析模型, 尽管它比Ni shi ta提出的模型限制更大(例如只对地面上的观察者有效). 值得一提的是,  在 siggraph 2011 上, Jensen & al. 发表了一篇关于夜空模拟的论文(“A Physically-based nightsky model”). 本章将提出西下模型的实现。在接下来的章节中，我们将研究其他算法.

在下一小节,我们会描述各种不同的现象, 他们放在一起组合成了天空的颜色. 我们会展示 Nishita 的算法如何模拟这些现象. 一旦我们有用 c++ 实现的模型, 我们会展示我们可以轻易的扩展这项技术来模拟空气透视, 通过修改模型的参数, 我们还可以创建外星天空

## 大气模型

大气是围绕着行星的一层气体. 大气主要由它的厚度和组成成分定义. 地球大气的厚度大约100km, 是由氧、氮、氩(瑞利发现的一种气体)、二氧化碳和水蒸气组成的. 然而在模拟中我们使用的厚度为60km(我们只考虑地球大气前两层的散射, 对流层(troposphere) 和平流层(stratosphere)). 当光线由一个特定方向传播进体(大气), 当光子和粒子碰撞时会偏折到其他方向. 这个现象叫做散射. 光线会多频繁的被粒子散射主要和粒子的属性(主要是尺寸)和粒子间密度有关.  我们现在知道组成大气的分子的大小我们还知道它们的密度. 我们将用这些科学度量做大气散射模拟. 大气的更重要的一个方面是, 粒子的密度会随着高度减少. 换句话说, 在海平面的每个单位立方体里粒子数量比海拔两千米处更多. 当光线充更高处进入大气, 我们需要沿着传播路径固定间隔采样大气密度并计算采样位置处的散射数量.大多数研究假定大气密度成指数地随着高度减小. 其可以被建模为如下的简单方程: 

$$density(h) = density(0)e^{-\frac{h}{H}}$$

其中 h 是当前高度, H 是大气密度均匀时的厚度(在科学论文中 H 被叫做 scale height 事实上和大气密度减少到1/e处的高度相关, H 和温度有关).一些论文声称这是一个很好的近似, 然而另一些声称这是不正确的, 倾向于将天空密度建模为一系列由厚度和密度决定的同心层.

大气在低海拔处还混合着称作气溶胶(aerosols)的大个粒子. 这些粒子可能是灰尘或沙粒. 它们在大气表现上有重要的作用, 尤其是因为它们和大气分子散射光线的方式不同. 大气分子散射光线的方式叫做 **雷利散射(Rayleigh scattering)** , 气溶胶散射光线的方式叫做 **米式散射(Mi e scattering)**. 简单来说, 雷利散射造成天空的蓝色(或者橙色, 红色..), 米氏散射造成像受污染的城市上的灰白色烟雾.  这个模型如果不提及可以接受用户指定的行星和天空的半径是不完整的. 这些数字会被用来计算采样位置的海拔. 对于地球, 我们将会使用 $$R_e = 6360km $$(e 代表), $$R_a = 6420km$$(a 代表大气). 

最后我们通过指定天空的主要光源是太阳来完成对模型的描述. 太阳离地球非常远, 我们可以假定到达大气的光是平行光. 我们将进一步说明这种观察如何简化我们的模型的实现.

## 雷利散射

大气分子对光照的散射和波长有强关联, 更精确的说, 大气分子相比于绿色和红色, 散射了更多的蓝色. 雷利提出的计算分子体的散射系数的方程只适用于粒子尺寸远小于可见光波长的情况(粒子至少比散射波长的1/10小). 可见光的波长范围是 380nm 到 780nm, 440, 550, 680是蓝色, 绿色, 和红色光的波峰. 雷利散射方程提供了已知分子密度时的散射系数. 大气散射的散射系数一般记为 $$\beta$$.

$$\beta_R^s(h, \lambda) = \frac{8\pi^3(n^2 - 1)^2}{3N\lambda^4}e^{-\frac{h}{H_R}}$$

上标S表示散射, 下标R表示雷利(用以区别于米氏散射). $$\lambda$$是波长, N 是海平面分子密度. n 是空气折射率. 在我们的模拟中, $$H_R = 8km$$. 正如你能在公式中看到的那样, 波长更短的光线会有更大的散射系数. 这也解释了为什么白天天空是蓝色的. 当光线从太阳传播到大气, 比红色和绿色更多的蓝色散射到观察者的眼睛中. 那么为什么在日出日落时是橙红色呢? 在这种特定情况下, 来自太阳的光线必须在大气中传播更多的距离来到达观察者的眼睛, 大部分蓝色在到达眼睛前就散射掉了, 而没有散射那么多次的红色保留了下来. 

我们可以使用一些 N, n 等的测量值来计算散射系数. 但我们使用对应海平面的天空?的预计算值(波长440, 550, 680的散射系数分别是33.1e-6m-1, 13.5e-6m-1, 5.8e-6m-1). 通过调整公式的指数部分, 我们可以得到不同海拔下的系数.



## 米氏散射

米氏散射