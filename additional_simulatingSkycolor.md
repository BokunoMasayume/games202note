# [模拟天空的颜色](https://www.scratchapixel.com/lessons/procedural-generation-virtual-worlds/simulating-sky/simulating-colors-of-the-sky)

## 介绍

几个世纪以来, 天空对于致力于尽量精确的描述天空颜色的艺术家非常有魅力. 19世纪前的物理和数学家很想弄清楚是什么导致了天空在日落时时橙色, 白天却是蓝色的. 在历史上, 认为雷利(Rayleigh)发现了大气散射. 大气散射在物体的表现上同样有影响. 这个效果被称作空气透视(aerial perspective). 随着物体和观察者间的距离增加, 物体的颜色被替换为大气的颜色. 这是一个重要的线索, 我们用来评估一个在天际线的物体的距离, 通过比较他们之间的蓝色的深浅. 在图像绘制时, 空气透视可以极大的增加图像的深度. 

更近的历史时计算机图形学的历史, Nishita 在1993年写了一篇开创性的文章“display of the earth taking into account atmospheric scattering”, 在文章中, 他描述了一个模拟天空颜色的算法. 有趣的是, 他的这篇文章和在1996年写的下一篇并不完全关于大气模拟, 而是更注重地球在外太空看到的真实感渲染(包括海水表面, 云和大陆的渲染).

这提醒我们，近年来，计算机图形技术的发展是由制造业驱动的，以精确模拟其产品或提供三维虚拟训练环境, 而不是由娱乐工业驱动?. Nishita 提出的这个技术在他的时代没什么水花. 这一领域的大部分研究都集中在在GPU上实现他的算法, 而没有明显的仿真质量的改善. 另一个天空模型由Preetham & al. 在 siggraph 1999 的文章“A Practical Analytic Model for Daylight”提出. 正如其标题暗示的, 这是一个能提供正确天空颜色模拟的分析模型, 尽管它比Ni shi ta提出的模型限制更大(例如只对地面上的观察者有效). 值得一提的是,  在 siggraph 2011 上, Jensen & al. 发表了一篇关于夜空模拟的论文(“A Physically-based nightsky model”). 本章将提出西下模型的实现。在接下来的章节中，我们将研究其他算法.

在下一小节,我们会描述各种不同的现象, 他们放在一起组合成了天空的颜色. 我们会展示 Nishita 的算法如何模拟这些现象. 一旦我们有用 c++ 实现的模型, 我们会展示我们可以轻易的扩展这项技术来模拟空气透视, 通过修改模型的参数, 我们还可以创建外星天空

## 大气模型

大气是围绕着行星的一层气体. 大气主要由它的厚度和组成成分定义. 地球大气的厚度大约100km, 是由氧、氮、氩(瑞利发现的一种气体)、二氧化碳和水蒸气组成的. 然而在模拟中我们使用的厚度为60km(我们只考虑地球大气前两层的散射, 对流层(troposphere) 和平流层(stratosphere)). 当光线由一个特定方向传播进体(大气), 当光子和粒子碰撞时会偏折到其他方向. 这个现象叫做散射. 光线会多频繁的被粒子散射主要和粒子的属性(主要是尺寸)和粒子间密度有关.  我们现在知道组成大气的分子的大小我们还知道它们的密度. 我们将用这些科学度量做大气散射模拟. 大气的更重要的一个方面是, 粒子的密度会随着高度减少. 换句话说, 在海平面的每个单位立方体里粒子数量比海拔两千米处更多. 当光线充更高处进入大气, 我们需要沿着传播路径固定间隔采样大气密度并计算采样位置处的散射数量.大多数研究假定大气密度成指数地随着高度减小. 其可以被建模为如下的简单方程: 

$$density(h) = density(0)e^{-\frac{h}{H}}$$

其中 h 是当前高度, H 是大气密度均匀时的厚度(在科学论文中 H 被叫做 scale height 事实上和大气密度减少到1/e处的高度相关, H 和温度有关).一些论文声称这是一个很好的近似, 然而另一些声称这是不正确的, 倾向于将天空密度建模为一系列由厚度和密度决定的同心层.

大气在低海拔处还混合着称作气溶胶(aerosols)的大个粒子. 这些粒子可能是灰尘或沙粒. 它们在大气表现上有重要的作用, 尤其是因为它们和大气分子散射光线的方式不同. 大气分子散射光线的方式叫做 **雷利散射(Rayleigh scattering)** , 气溶胶散射光线的方式叫做 **米式散射(Mie scattering)**. 简单来说, 雷利散射造成天空的蓝色(或者橙色, 红色..), 米氏散射造成像受污染的城市上的灰白色烟雾.  这个模型如果不提及可以接受用户指定的行星和天空的半径是不完整的. 这些数字会被用来计算采样位置的海拔. 对于地球, 我们将会使用 $$R_e = 6360km $$(e 代表), $$R_a = 6420km$$(a 代表大气). 

最后我们通过指定天空的主要光源是太阳来完成对模型的描述. 太阳离地球非常远, 我们可以假定到达大气的光是平行光. 我们将进一步说明这种观察如何简化我们的模型的实现.

## 雷利散射

大气分子对光照的散射和波长有强关联, 更精确的说, 大气分子相比于绿色和红色, 散射了更多的蓝色. 雷利提出的计算分子体的散射系数的方程只适用于粒子尺寸远小于可见光波长的情况(粒子至少比散射波长的1/10小). 可见光的波长范围是 380nm 到 780nm, 440, 550, 680是蓝色, 绿色, 和红色光的波峰. 雷利散射方程提供了已知分子密度时的散射系数. 大气散射的散射系数一般记为 $$\beta$$.

$$\beta_R^s(h, \lambda) = \frac{8\pi^3(n^2 - 1)^2}{3N\lambda^4}e^{-\frac{h}{H_R}}$$

上标S表示散射, 下标R表示雷利(用以区别于米氏散射). $$\lambda$$是波长, N 是海平面分子密度. n 是空气折射率. 在我们的模拟中, $$H_R = 8km$$. 正如你能在公式中看到的那样, 波长更短的光线会有更大的散射系数. 这也解释了为什么白天天空是蓝色的. 当光线从太阳传播到大气, 比红色和绿色更多的蓝色散射到观察者的眼睛中. 那么为什么在日出日落时是橙红色呢? 在这种特定情况下, 来自太阳的光线必须在大气中传播更多的距离来到达观察者的眼睛, 大部分蓝色在到达眼睛前就散射掉了, 而没有散射那么多次的红色保留了下来. 

我们可以使用一些 N, n 等的测量值来计算散射系数. 但我们使用对应海平面的天空?的预计算值(波长440, 550, 680的散射系数分别是33.1e-6m-1, 13.5e-6m-1, 5.8e-6m-1). 通过调整公式的指数部分, 我们可以得到不同海拔下的系数.

如果你看了[体渲染](https://www.scratchapixel.com/lessons/advanced-rendering/volume-rendering-for-artists)那节课, 你会知道用来描述参与介质渲染的是散射系数(scattering coefficient), 吸收系数(absorption coefficient)和描述当和物体碰撞的时候多少光以及那个方向的光会被散射的相位函数(phase function). 到这节课的目前为止, 我们只有地球大气的散射系数. 大气散射的吸收部分是微不足道的, 所以我们通常会假定大气不会吸收光线. 像在体渲染时提到的, 我们在物理模型中用到的消退系数(extinction coefficient)是吸收系数和散射系数的和, 而吸收系数为0, 因此消退系数为: 

$$\beta^e_R = \beta^s_R$$

雷利相位函数如下: 

$$P_R(\mu) = \frac{3}{16\pi}(1 + \mu^2)$$

## 米氏散射

米氏散射和雷利散射类似, 但是适用于粒子尺寸大于散射波长的粒子. 如果我们对低海拔处的气溶胶使用雷利散射公式, 没办法得到看起来正常的图像. 米氏散射计算散射系数的公式如下: 

$$\beta^s_M(h, \lambda) = \beta^s_M(0, \lambda)e^{-\frac{h}{H_M}}$$

下标M表示米氏. 注意米氏散射有一个特定的scale height value $$H_M$$, 一般设置为1.2km.  不同于雷利散射, 我们不需要计算米氏散射系数的方程, 我们用在海平面处测量得到的值代替$$\beta_s = 210e^{-5} m^{-1}$$. 气溶胶的密度也随着海拔呈指数下降, 我们通过在方程的右边包含一个指数项来模拟这一点.  米氏消退系数大约是它的散射系数的1.1倍. 米氏相位函数公式如下: 

$$P_M(\mu) = \frac{3}{8\pi}\frac{(1 - g^2)(1 + \mu^2)}{(2 + g^2)(1 + g^2 - 2g\mu)^{\frac{3}{2}}}$$

米氏相位函数包含了项 g (雷利相位函数里木有), 用来控制介质的各项异性. 气溶胶显示出很强的forward directivity. 一些文章中使用 $$g = 0.76$$.



## 光学深度(optical depth)概念

在着手进行可以实际实现的代码之前, 我们先把拼图的碎片拼起来. 首先, 我们需要明白, 天空就是围绕着实心球的一个球形体. 因为它就是一个体(volume), 我们可以用光线步进算法渲染天空, 光线步进算法是渲染中间介质最常用的技术. 我们在体渲染那里详细学习了这个算法. 当我们渲染一个体, 观察者可能在体的外部或内部.

当相机在里面, 我们需要找到视线离开体的点, 当在外面, 我们需要找到视线进入和离开体的点. 因为天空是个球形, 所以我们用射线-球相交法计算这些点. 我们可以通过相机的海拔高度判断它在不在大气里面. 

现在我们假设相机在地面上(或者离地面1米高上). 我们假设我们有个视线涉嫌, 并且知道它这个涉嫌和大气顶部的哪里相交. 在这个相交点上, 我们要解决的问题就是有多少光线沿着这条射线来到观察者这里. 

在一切情况下, 如果你看向天空的方向, 你不应该看到任何东西, 因为你在看向外太空. 然而事实却是你看到了蓝色. 这是由于进入大气的阳光朝着视线方向发生了偏折. 也就是说, 没有来自于太阳的光线直接进入眼睛(除非你直视太阳). 这种现象被称作**单次折射(single scattering)?**(在体渲染那章有解释). 

现在我们知道渲染帧上一个像素的天空颜色. 我们首先从点$$P_c$$发射一个视线(V). 我们要计算和大气的交点$$P_a$$. 最后我们需要计算由于单次折射沿着这条线的总光线. 计算这个值的公式可以用体渲染中说过的:

$$L(P_c, P_a) = \int_{P_c}^{P_a}T(P_c, X)L_{sun}(X)ds$$

其中T是点$$P_c$$和X(沿着视线方向的采样点)间的投射率(transmittance), L是体中点X处的总光线. 到达观察点$$P_c$$的光的总量等于沿着观察者方向散射的所有光线的总量. 这个值可以通过求和V上大量的采样点$$X$$得到. 这个技术叫做数值积分. 采样越多的点, 就能得到更好的结果, 但会造成更大的计算量. 透光率(transmittance)项代表了在每个采样点, 光沿着V散射, 从X到$$P_c$$也会有衰减.

在体渲染章节提到过, 在体中从一个点到另一个点的衰减由吸收和外散射导致 . 我们把在$$P_b$$处有的光的总量叫做$$L_b$$, 从$$P_b$$到达$$P_a$$的光的总量叫做$$L_a$$. 由于存在中间介质, La会比Lb少.透射率表示$$L_a / L_b$$, T在0-1之间. 

$$T(P_a, P_b) = \frac{L_a}{L_b} = exp(-\sum^{P_b}_{P_a}\beta_e(h)ds)$$

这个公式就是说我们需要在路径pa-pb上我们需要测量每个采样点的消散系数, 把这些值加起来, 乘以段长度ds, 再搞到指数上.

上面说过大气的吸收系数可视为0, 消散系数可约等于散射系数, 所以上面的式子可以重写为下面:

$$T(P_a, P_b) = exp(-\beta_e(0)\sum^{P_b}_{P_a}exp(-\frac{h}{H})ds)$$

在指数上的和可以视为papb间的平均密度, 公式本身被称为大气中papb间的光学深度.

## 加入阳光

最后我们使用上面的式子计算天空颜色. 现在我们看看怎么计算$$L_sun{X}$$项. 这个项对应采样点X上散射到视线方向的光线总量. 为了估计它, 首先我们要计算到达X的光线总量. 直接用光线强度不够. 事实上, 如果光线从Ps点进入大气, 到达X时会被衰减. 因此需要用T来计算这个衰减.

$$L_{sun}(X) = Sun Intensity * T (X, P_s)$$ 					**Equation 1**

在视线方向的每个采样位置X, 我们需要发射一条到光线方向的射线(L), 并找到这条线和大气的交点(Ps). 

在构建计算天空颜色的算法的最后一个元素是，根据光方向本身和视图方向，考虑散射在观察方向上的光的总量. 这是相位函数要做的. 雷利散射和米氏散射都有自己的相位函数. 相位函数描述了来自方向L的光有多少散射到了方向V. 米氏相位函数包含了一个额外的项g, 被称作 **平均余弦(mean cosine)**, 定义了光线是沿着前向(L)还是反向(-L). 对前向, g在0-1之间,对反向, g在-1-0之间.  当g为0 , 光线均等的散射到各个方向, 我们说这时是各项同性的. **对米氏散射我们把g设置为0.76**.

$$L_{sun}(X) = Sun Intensity * T (X, P_s) * P(V, L)$$

最后我们需要考虑雷利散射导致的光是蓝色的. 为了反应这个事实, 我们在上个公式的结果上乘以散射系数$$\beta_s$$, 现在得到的就是光部分的完整方程. 

$$L_{sum}(X) = sun intensity * T(X, P_s) * P(V,L) * \beta_s(h)$$

$$L(X) = \int_{4\pi}Light IntensityT(X, P_s) * P(V,L) * \beta_s(h)$$

> 对于地球大气来说, 太阳是天空唯一的光源, 为了写个上个公式的更加一般的形式, 我们要考虑光线可能来自各个不同的方向. 这个更一般的方程还可以考虑到被地面反射的阳光(多次散射)，这在本章中我们将忽略.

## 计算天空的颜色

把所有的参数放在一起, 我们可以得到如下的公式

$$skyColor(P_c, P_a) = \int_{P_c}^{P_a}T(P_c, X)L_{sum}(X)ds$$				**Equation 2**

$$L_{sun}(X) = SunIntensity * T(X, P_s)*P(V,L)*\beta_s(h)$$	**Equation 3**

如果我们把3带入到2中, 相位函数的结果是个常量, 和阳光强度相同. 因此我们可以把他们移到一起

$$SkyColor(P_c, P_a) = SunIntensity*P(V, L) \int T(P_c,X)*T(X, P_s)*\beta_s(h)ds$$	**Equation 4**

这是渲染指定视图方向和光方向的天空颜色的最后一个公式. 它不是特别复杂. 它的计算复杂度来自于指数计算和积分. 另外, 你需要记住, 天空的颜色是雷利散射和米氏散射一起作用的结果, 因此我们需要 把这个公式对每种散射计算一次

$$SkyColor(P_c, P_a) = SkyColor_{Rayleigh}(P_c, P_a) + SkyColor_{Mie}(P_c, P_a)$$

鉴于指数计算的一些方式, 可以做如下优化(把两次指数计算变成一次)

$$T(P_c, X) * T(X, P_s) = e^{-\beta_{e0}} * e^{-\beta_{e1}} = e^{-(\beta_{e0}+\beta_{e1})}$$	**Equation 5**



## 实现 

> 优化点: Nishita观察到天空对太阳位置到地球中心点的位置形成的轴对称(中心对称). 基于这个观察, 那篇文章提出了可以将光学深度(optical depth)烘焙到一张2D表中, 你可以通过使用$$\mu$$(光线方向和观察方向夹角的cosine)和h(采样点的高度)查找. 这个表可以预先计算存储, 并在实时计算时使用. 



## 光柱 light shafts

大气效果有时会造成特定的视觉效果. 光柱通常使这些效果更棒. 如果光线自由的在体中传播, 体会被均匀的照亮. 但如果我们在场景中添加一些物体, 体中被这些物体遮挡的部分会更暗. 光柱是与被光源照亮的体块区域相对应的光束.只有当一部分体区域被物体遮挡的时候才能被看到.



## 模拟空中视角 Simulating Aerial Perspective

地面物体的颜色被蓝色大气影响. 大气对离眼睛更近位置的颜色影响比较远处小. 

首先你需要渲染出物体在光线下的颜色, 然后你要渲染透光度(也就是透明度)和大气的颜色(pc, pa 分别是观察位置和视线到物体的交点).最后的颜色就是

$$rayColor = ObjectColor * (1 - transmittance) + atmosphereColor$$

## 外星天空 Alien Skies

变参数就完事了